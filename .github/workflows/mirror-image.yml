name: Mirror Image from GHCR to DockerHub

on:
  workflow_dispatch:
    inputs:
      ghcr_owner:
        description: 'GHCR 用户名/组织名'
        required: true
        default: 'komari-monitor'
      ghcr_repo:
        description: 'GHCR 仓库名'
        required: true
        default: 'komari'
      ghcr_tag:
        description: 'GHCR 标签号'
        required: true
        default: 'latest'
      dockerhub_repo:
        description: 'DockerHub 仓库名 (留空则使用 GHCR 仓库名)'
        required: false
        default: ''
      dockerhub_tag:
        description: 'DockerHub 标签号 (留空则使用 GHCR 标签号)'
        required: false
        default: ''

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: 设置变量
        id: vars
        run: |
          DOCKERHUB_REPO="${{ github.event.inputs.dockerhub_repo }}"
          DOCKERHUB_TAG="${{ github.event.inputs.dockerhub_tag }}"
          
          if [ -z "$DOCKERHUB_REPO" ]; then
            DOCKERHUB_REPO="${{ github.event.inputs.ghcr_repo }}"
          fi
          
          if [ -z "$DOCKERHUB_TAG" ]; then
            DOCKERHUB_TAG="${{ github.event.inputs.ghcr_tag }}"
          fi
          
          echo "dockerhub_repo=$DOCKERHUB_REPO" >> $GITHUB_OUTPUT
          echo "dockerhub_tag=$DOCKERHUB_TAG" >> $GITHUB_OUTPUT

      - name: 登录 GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 登录 DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 拉取镜像
        run: |
          SOURCE_IMAGE="ghcr.io/${{ github.event.inputs.ghcr_owner }}/${{ github.event.inputs.ghcr_repo }}:${{ github.event.inputs.ghcr_tag }}"
          echo "拉取镜像: $SOURCE_IMAGE"
          docker pull $SOURCE_IMAGE

      - name: 标记并推送镜像
        run: |
          SOURCE_IMAGE="ghcr.io/${{ github.event.inputs.ghcr_owner }}/${{ github.event.inputs.ghcr_repo }}:${{ github.event.inputs.ghcr_tag }}"
          TARGET_IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${{ steps.vars.outputs.dockerhub_repo }}:${{ steps.vars.outputs.dockerhub_tag }}"
          
          echo "标记镜像: $SOURCE_IMAGE -> $TARGET_IMAGE"
          docker tag $SOURCE_IMAGE $TARGET_IMAGE
          
          echo "推送镜像: $TARGET_IMAGE"
          docker push $TARGET_IMAGE
          
          echo "✅ 镜像同步完成！"
          echo "源镜像: $SOURCE_IMAGE"
          echo "目标镜像: $TARGET_IMAGE"
